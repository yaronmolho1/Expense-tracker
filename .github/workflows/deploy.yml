name: Deploy to Production

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]
  workflow_dispatch:  # Allow manual deployment

jobs:
  # Only deploy if CI passed
  check-ci:
    name: Verify CI Passed
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - run: echo "CI passed, proceeding with deployment"

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: check-ci
    environment: production

    steps:
      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd ~/docker-app-stack/apps/expense-tracker

            echo "üì¶ Pulling latest code from main..."
            GIT_SSH_COMMAND='ssh -i ~/.ssh/id_ed25519_github -o IdentitiesOnly=yes' git pull origin main

            echo "üèóÔ∏è  Building Docker images..."
            docker compose -f docker-compose.production.yml build

            echo "üöÄ Deploying containers..."
            docker compose -f docker-compose.production.yml up -d

            echo "‚è≥ Waiting for services to start..."
            sleep 15

            echo "üè• Running health check..."
            curl -f http://localhost:3000/api/health || {
              echo "‚ùå Health check failed!"
              docker compose -f docker-compose.production.yml logs --tail=50
              exit 1
            }

            echo "üßπ Cleaning up old Docker images..."
            docker image prune -f

            echo "‚úÖ Deployment complete!"

      - name: Notify success
        if: success()
        run: |
          echo "‚úÖ Production deployment successful!"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"

      - name: Notify failure
        if: failure()
        run: |
          echo "‚ùå Production deployment failed!"
          echo "Check server logs for details"
